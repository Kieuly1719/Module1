<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Nh√¢n vi√™n</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <h1 id="welcome_message">Ch√†o m·ª´ng, [T√™n Nh√¢n vi√™n]</h1>
    <nav>
        <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
    </nav>
</header>

<main>
    <section id="profile_section">
        <h2>üë§ Th√¥ng tin C√° nh√¢n</h2>
        <div id="profile_details"></div>
        <button onclick="toggleEditMode()" id="edit_toggle_btn">Ch·ªânh s·ª≠a/ƒê·ªïi MK</button>

        <form id="edit_profile_form" style="display: none; margin-top: 20px;">
            <h3>Ch·ªânh s·ª≠a Th√¥ng tin</h3>
            <label for="emp_name_edit">T√™n (Kh√¥ng s·ª≠a):</label>
            <input type="text" id="emp_name_edit" disabled>

            <label for="emp_phone_edit">SƒêT:</label>
            <input type="tel" id="emp_phone_edit">

            <label for="emp_email_edit">Email:</label>
            <input type="email" id="emp_email_edit">

            <label for="emp_address_edit">ƒê·ªãa ch·ªâ:</label>
            <input type="text" id="emp_address_edit">

            <h3>ƒê·ªïi M·∫≠t kh·∫©u</h3>
            <label for="old_password">M·∫≠t kh·∫©u c≈©:</label>
            <input type="password" id="old_password" required>

            <label for="new_password">M·∫≠t kh·∫©u m·ªõi:</label>
            <input type="password" id="new_password" required>

            <button type="submit" class="submit-btn">L∆∞u v√† ƒê·ªïi MK</button>
        </form>
    </section>

    <hr>

    <section id="leave_request_section">
        <h2>üìù N·ªôp ƒê∆°n Xin Ngh·ªâ Ph√©p</h2>
        <form id="submit_leave_form">
            <label for="leave_from">T·ª´ ng√†y:</label>
            <input type="date" id="leave_from" required>

            <label for="leave_to">ƒê·∫øn ng√†y:</label>
            <input type="date" id="leave_to" required>

            <label for="leave_reason">L√Ω do:</label>
            <textarea id="leave_reason" required></textarea>

            <button type="submit" class="submit-btn">G·ª≠i ƒê∆°n</button>
        </form>
    </section>

    <hr>

    <section id="salary_slip_section">
        <h2>üí∞ Phi·∫øu L∆∞∆°ng G·∫ßn Nh·∫•t</h2>
        <div id="salary_details"></div>
    </section>

    <hr>

    <section id="leave_history_section">
        <h2>L·ªãch s·ª≠ ƒê∆°n ngh·ªâ ph√©p ƒë√£ n·ªôp</h2>
        <table>
            <thead>
            <tr><th>T·ª´</th><th>ƒê·∫øn</th><th>L√Ω do</th><th>Tr·∫°ng th√°i</th></tr>
            </thead>
            <tbody id="my_leave_history">
            </tbody>
        </table>
    </section>

</main>

<script src="qlnv.js"></script>
<script>
    // --- LOGIC CHUNG ---
    const currentUserId = parseInt(sessionStorage.getItem('currentUserId'));
    let currentUser;

    function checkAuth() {
        if (!currentUserId) {
            window.location.href = 'login.html';
            return false;
        }
        const danhSach = taiDanhSachNV();
        currentUser = danhSach.find(emp => emp.id === currentUserId);
        if (!currentUser) {
            window.location.href = 'login.html';
            return false;
        }
        document.getElementById('welcome_message').textContent = `Ch√†o m·ª´ng, ${currentUser.name}`;
        return true;
    }

    function logout() {
        sessionStorage.removeItem('currentUserId');
        window.location.href = 'login.html';
    }

    function displayProfile() {
        const detailDiv = document.getElementById('profile_details');
        detailDiv.innerHTML = `
                <p><strong>ID:</strong> ${currentUser.id}</p>
                <p><strong>T√™n:</strong> ${currentUser.name}</p>
                <p><strong>Ch·ª©c v·ª•:</strong> ${currentUser.position}</p>
                <p><strong>SƒêT:</strong> ${currentUser.phone}</p>
                <p><strong>Email:</strong> ${currentUser.email}</p>
                <p><strong>ƒê·ªãa ch·ªâ:</strong> ${currentUser.address}</p>
            `;

        document.getElementById('emp_name_edit').value = currentUser.name;
        document.getElementById('emp_phone_edit').value = currentUser.phone;
        document.getElementById('emp_email_edit').value = currentUser.email;
        document.getElementById('emp_address_edit').value = currentUser.address;
    }

    function toggleEditMode() {
        const form = document.getElementById('edit_profile_form');
        const btn = document.getElementById('edit_toggle_btn');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            btn.textContent = '·∫®n Form Ch·ªânh S·ª≠a';
        } else {
            form.style.display = 'none';
            btn.textContent = 'Ch·ªânh s·ª≠a/ƒê·ªïi MK';
        }
    }

    document.getElementById('edit_profile_form').addEventListener('submit', function(e) {
        e.preventDefault();

        const oldPass = document.getElementById('old_password').value;
        const newPass = document.getElementById('new_password').value;

        if (oldPass !== currentUser.password) {
            alert("M·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng!");
            return;
        }

        const updatedUser = {
            ...currentUser, // Gi·ªØ l·∫°i c√°c thu·ªôc t√≠nh c≈©
            phone: document.getElementById('emp_phone_edit').value,
            email: document.getElementById('emp_email_edit').value,
            address: document.getElementById('emp_address_edit').value,
            password: newPass // C·∫≠p nh·∫≠t m·∫≠t kh·∫©u m·ªõi
        };

        capNhatNhanVien(updatedUser); // S·ª≠ d·ª•ng h√†m Admin ƒë√£ vi·∫øt
        alert("C·∫≠p nh·∫≠t th√¥ng tin v√† m·∫≠t kh·∫©u th√†nh c√¥ng!");
        window.location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
    });

    // --- CH·ª®C NƒÇNG N·ªòP ƒê∆†N NGH·ªà PH√âP ---
    document.getElementById('submit_leave_form').addEventListener('submit', function(e) {
        e.preventDefault();

        const from = document.getElementById('leave_from').value;
        const to = document.getElementById('leave_to').value;
        const reason = document.getElementById('leave_reason').value;

        nopDonNghiPhep(currentUserId, currentUser.name, from, to, reason);

        alert("ƒê∆°n ngh·ªâ ph√©p ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒëi. Vui l√≤ng ƒë·ª£i Admin ph√™ duy·ªát.");
        e.target.reset(); // X√≥a form
        displayLeaveHistory(); // C·∫≠p nh·∫≠t l·ªãch s·ª≠
    });

    function displaySalarySlip() {
        const slipDiv = document.getElementById('salary_details');
        const grossSalary = currentUser.baseSalary;
        const taxRate = 0.1; // Thu·∫ø (M√¥ ph·ªèng 10%)
        const tax = grossSalary * taxRate;
        const netSalary = grossSalary - tax;

        slipDiv.innerHTML = `
                <p><strong>Th√°ng:</strong> ${new Date().getMonth() + 1}/${new Date().getFullYear()}</p>
                <p><strong>L∆∞∆°ng C∆° B·∫£n:</strong> ${grossSalary.toLocaleString('vi-VN')} VNƒê</p>
                <p><strong>Thu·∫ø (10% m√¥ ph·ªèng):</strong> ${tax.toLocaleString('vi-VN')} VNƒê</p>
                <p style="font-size: 1.2em; color: green;"><strong>TH·ª∞C Lƒ®NH:</strong> ${netSalary.toLocaleString('vi-VN')} VNƒê</p>
            `;
    }

    // --- L·ªäCH S·ª¨ NGH·ªà PH√âP ---
    function displayLeaveHistory() {
        const tableBody = document.getElementById("my_leave_history");
        tableBody.innerHTML = '';

        const danh_sach_nghi_phep = taiDanhSachNghiPhep();
        const myRequests = danh_sach_nghi_phep.filter(req => req.empId === currentUserId);

        myRequests.forEach(req => {
            const row = tableBody.insertRow();
            row.insertCell().textContent = req.from;
            row.insertCell().textContent = req.to;
            row.insertCell().textContent = req.reason;
            row.insertCell().textContent = req.status;
        });
    }

    // --- KH·ªûI CH·∫†Y ---
    if (checkAuth()) {
        displayProfile();
        displaySalarySlip();
        displayLeaveHistory();
    }
</script>
</body>
</html>